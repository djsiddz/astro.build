---
import Icon from "astro-icon"
import ChevronIcon from "~/icons/ChevronIcon.jsx"
---

<div data-code-block class="px-4 py-2 bg-astro-dark-900/40 backdrop-blur-lg rounded-xl">
	<div class="group h-full flex items-center">
		<ChevronIcon class="mr-2 relative block w-3 -rotate-90 text-astro-gray-200" aria-hidden="true" />

		<code data-code class="flex-1 font-mono font-light text-sm text-astro-gray-200 mr-2">
			<slot />
		</code>

		<div class="relative">
			<button
				data-copy-button
				class="block mr-1 transition hover:scale-110 active:scale-100 active:transition-colors text-astro-gray-300 group-hover:text-astro-gray-100"
				title="Copy to clipboard"
			> 
				<Icon name="ri:file-copy-line" size={20} aria-hidden="true" />
			</button>

			<p
				data-tooltip
				class="absolute left-1/2 top-[calc(100%+8px)] -translate-x-1/2 whitespace-nowrap rounded bg-black/50 p-2 text-sm leading-none opacity-0 transition data-[visible=true]:opacity-100"
			>
				Copied!
			</p>
		</div>
	</div>
</div>

<script>
	import { createEffect } from "solid-js"
	import { getElement } from "~/helpers/dom.js"
	import { createTimer } from "~/helpers/timer.js"

	for (const codeBlock of document.querySelectorAll("[data-code-block]")) {
		const code = getElement("[data-code]", HTMLElement, codeBlock)
		const button = getElement("[data-copy-button]", HTMLButtonElement, codeBlock)
		const tooltip = getElement("[data-tooltip]", HTMLElement, codeBlock)

		const timer = createTimer(1500)

		button.addEventListener("click", () => {
			navigator.clipboard.writeText(code.innerText)
			timer.start()
		})

		createEffect(() => {
			button.title = timer.running() ? "Copied!" : "Copy to clipboard"
			tooltip.dataset.visible = String(timer.running())
			tooltip.ariaHidden = String(!timer.running())
		})
	}
</script>
